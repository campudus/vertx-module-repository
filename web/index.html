<!DOCTYPE html>
<html>
<head>
<title>Vert.x Module Registry</title>
<link rel="stylesheet" type="text/css" href="/css/normalize.css" />
<link rel="stylesheet" type="text/css" href="/css/main.css" />
<script src="js/jquery.js" type="text/javascript"></script>
<script>
  var sid;

  function fillLatestApprovedMods() {
    $.getJSON('/latest-approved-modules', function(data) {
      $('#latestApprovedModules').append(getLiFromMods(data.modules));
    });
  }

  function getLiFromMods(modules) {
    var item, items = '<ul>';
    while (modules.length) {
      item = modules.pop();
      items += '<li><span class="date">' + formatTimestamp(item.timeApproved)
          + '</span> - <a href="' + item.projectUrl + '">' + item.owner + '~' + item.name + '~'
          + item.version + '</a></li>';
    }
    items += '</ul>';
    return items;
  }

  function formatTimestamp(time) {
    var date = new Date(time);
    var months = [ 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov',
        'Dec' ];
    var year = date.getFullYear();
    var month = months[date.getMonth()];
    var day = date.getDate();
    var hour = date.getHours();
    var min = date.getMinutes();
    var sec = date.getSeconds();
    var time = day + ' ' + month + ' ' + year + ' ' + hour + ':' + min + ':' + sec;

    return time;
  }

  function createSearchFormSubmitHandler() {
    $('#searchForm').submit(function(event) {
      event.preventDefault();
      $.post('/search', {
        query : $('#query').val()
      }, function(data) {
        $('#searchResults').empty();
        $('#searchResults').append(getLiFromMods(data.modules));
        $('#searchResultContainer').show();
      }, 'json');
    });
  }

  function createRegisterFormHandler() {
    $('a.showRegister').click(showRegisterForm);
    function showRegisterForm() {
      $('#registerFormContainer').show();
      displayHideLink();
      return false;
    }

    function displayHideLink() {
      $('a.showRegister').replaceWith('<a class="hideRegister href-less">registration form</a>')
      $('a.hideRegister').click(function() {
        $('#registerFormContainer').hide();
        displayShowLink();
      });
    }

    function displayShowLink() {
      $('a.hideRegister').replaceWith('<a class="showRegister href-less">registration form</a>')
      $('a.showRegister').click(showRegisterForm);
    }
  }

  function createUnapprovedModsHandler() {
    var loginContainer = $('#loginContainer');

    function resetForm() {
      $('#loginContainer #password').val('');
      $('#loginContainer .errorMessage').hide();
    }

    function hideForm() {
      $(loginContainer).fadeOut(300);
      $('#mask').fadeOut(300, function() {
        $(this).remove();
      });
    }

    function showLoginErrorMessage(error) {
      if ($('#loginContainer').is(':hidden')) {
        resetForm();
        showForm();
      }
      $('#loginContainer .errorMessage').show();
      $('#loginContainer .errorMessage').html(error);
    }

    function showForm() {
      $(loginContainer).fadeIn(300);

      // Align the box
      var margTop = $(loginContainer).height() / 2;
      var margLeft = $(loginContainer).width() / 2;

      $(loginContainer).css({
        'margin-top' : -margTop,
        'margin-left' : -margLeft
      });

      // Add mask to hide the background
      $('body').append('<div id="mask"></div>');
      $('#mask').fadeIn(300);

      $("#mask").click(function() {
        hideForm()
        return false;
      });
    }

    $('a.showUnapproved').click(showUnapproved);

    function showUnapproved() {
      if (sid) {
        getUnapproved()
      } else {
        resetForm();
        showForm();
      }

      return false;
    }

    $('a.close').click(function() {
      hideForm();
      return false;
    });

    $('#loginForm').submit(function(event) {
      event.preventDefault();
      $.post('/login', {
        password : $('#password').val()
      }, processLoginResult, 'json');
    });

    function processLoginResult(data) {
      if (data.status == 'ok' && data.sessionID) {
        sid = data.sessionID
        getUnapproved();
      } else if (data.status == 'error') {
        processStatusError(data);
      } else if (data.status == 'denied') {
        showLoginErrorMessage("Wrong password");
      } else {
        showLoginErrorMessage("Access denied");
      }
    }

    function getUnapproved() {
      $.getJSON('/unapproved', {
        sessionID : sid
      }, function(data) {
        if (data.modules) {
          $('#unapprovedModules').empty();
          $('#unapprovedModules').append(getLiFromMods(data.modules));
          hideForm();
          displayHideLink();
        } else if (data.status == 'denied') {
          showLoginErrorMessage("Bad session or session expired");
        } else {
          showLoginErrorMessage("Internal error");
        }
      })
    }

    function displayHideLink() {
      $('a.showUnapproved').replaceWith('<a class="hideUnapproved href-less">[Hide]</a>')
      $('a.hideUnapproved').click(function() {
        $('#unapprovedModules').empty();
        displayShowLink();
      });
    }

    function displayShowLink() {
      $('a.hideUnapproved').replaceWith('<a class="showUnapproved href-less">[Show]</a>')
      $('a.showUnapproved').click(showUnapproved);
    }

    function processStatusError(data) {
      var s = 'Missing password';
      var messages = data.messages;
      if (messages.length > 0) {
        s = messages.pop();
        while (messages.length)
          s += '<br />' + messages.pop();
      }
      showLoginErrorMessage(s);
    }
  }

  function generateName() {
    var nameA = [ "awesome", "amazing", "fantastic", "marvelous", "storming", "staggering",
        "exciting", "mind-blowing", "astonishing", "handsome", "beautiful", "admirable", "lovely",
        "gorgeous", "exceptional", "uncommon", "terribly nice", "outstanding", "fine-looking",
        "well-favored", "glorious", "pulchritudinous", "ravishing", "stunning", "dazzling",
        "mind-boggling", "attractive", "graceful", "pleasing", "charismatic", "enchanting" ];
    var nameB = [ "men", "guys", "dudes", "fellows", "jossers", "wallahs", "blokes", "fellas",
        "fellers", "chaps", "lads", "people", "humans", "geezers", "boys", "gorillas", "bananas",
        "champs", "rockers", "pals" ];
    var a = Math.floor(Math.random() * nameA.length);
    var b = Math.floor(Math.random() * nameB.length);
    var name = nameA[a] + ' ' + nameB[b];
    return name;
  }

  function fillName() {
    $('#footer .randomName').text(generateName());
  }

  $(document).ready(function() {
    createRegisterFormHandler();
    createUnapprovedModsHandler();
    fillLatestApprovedMods();
    createSearchFormSubmitHandler();
    fillName();
  });
</script>
</head>
<body id="container">
	<div id="container">
		<div id="loginContainer">
			<a class="close href-less"><img src="images/close.png" /></a>
			<form id="loginForm" method="post" action="/login">
				<fieldset>
					<label> <span>Password</span> <input id="password"
						type="password" placeholder="Password" value="" name="password">
					</label>
					<button type="submit">Login</button>
					<span class="errorMessage">error</span>
				</fieldset>
			</form>
		</div>
		<div id="header">
			<h1>
				<span class="head">Vert.x Module Registry</span>
			</h1>
		</div>
		<div id="main">
			<div class="intro">
				<p>This is the Vert.x module registry. Here you can find all
					modules published by Vert.x users.</p>
			</div>
			<div id="search">
				<h2>Search</h2>
				<div id="searchForModules">
					<form action="/search" method="post" id="searchForm">
						<fieldset>
							<legend>Search for modules</legend>
							<div>
								<input type="text" name="query" placeholder="Query for modules"
									id="query" />
							</div>
							<button type="submit">Search</button>
						</fieldset>
					</form>
				</div>
				<div id="searchResultContainer">
					<h2>Search results</h2>
					<div id="searchResults"></div>
				</div>
			</div>
			<div class="col" id="left">
				<div id="latest">
					<h3>Latest approved modules</h3>
					<div id="latestApprovedModules"></div>
				</div>
				<div id="unapproved">
					<h3>Unapproved modules</h3>
					<p>
						<a class="showUnapproved href-less">[Show]</a>
					</p>
					<div id="unapprovedModules"></div>
				</div>
			</div>
			<div class="col" id="right">
				<h3>You should also visit</h3>
				<ul>
					<li><a href="http://campudus.com"><img
							src="images/campudus.png" alt="Campudus" /></a></li>
					<li><a href="http://vertx.io/"><img src="images/vertx.png"
							alt="GitHub" /></a></li>
					<li><a href="https://github.com/"><img
							src="images/github.png" alt="GitHub" /></a></li>
				</ul>
			</div>
			<div id="register">
				<h2>Register your own module</h2>
				<div class="intro">
					<p>
						To register your own module, simply fill out the <a
							class="showRegister href-less" href="/register">registration
							form</a>.
					</p>
				</div>
				<div id="registerFormContainer">
					<p>Please fill in the fields and submit your module. You'll
						need to wait for a moderator to approve your module. Feel free to
						ping us in IRC on Freenode.</p>
					<form id="registerForm" action="/register" method="POST">
						<div class="columns">
							<div class="col2" id="left">
								<fieldset>
									<legend>Module information</legend>
									<label for="downloadUrl"><span>Download URL</span> <input
										type="url" name="downloadUrl"
										placeholder="Download URL for this module" required="required" />
									</label> <label for="modname"><span>Name of your module
											(same as modname in gradle.properties)</span> <input type="text"
										name="modname" placeholder="Name of your module"
										required="required" /> </label> <label for="modowner"><span>Owner
											of the module (same as modowner in gradle.properties)</span> <input
										type="text" name="modowner"
										placeholder="Owner of the module (groupId)"
										required="required" /> </label> <label for="version"><span>Version
											of your module</span> <input type="text" name="version"
										placeholder="Version of your module" required="required" /> </label>
									<label for="vertxVersion"><span>Supported Vert.x
											Version</span> <input type="text" name="vertxVersion"
										placeholder="Supported Vert.x Version" /> </label>
								</fieldset>
							</div>
							<div class="col2" id="left">
								<fieldset>
									<legend>Project information</legend>
									<label for="projectUrl"><span>Project URL</span> <input
										type="url" name="projectUrl" placeholder="Project URL" /> </label> <label
										for="description"><span>Short description of
											your module</span> <input type="text" name="description"
										placeholder="Short description of your module"
										required="required" /> </label> <label for="author"><span>Module
											Author</span> <input type="text" name="author"
										placeholder="Module Author" /> </label> <label for="email"><span>E-mail
											of module author</span> <input type="email" name="email"
										placeholder="E-mail of module author" required="required" />
									</label> <span></span>
								</fieldset>
							</div>
							<div class="col2" id="left">
								<fieldset>
									<legend>Module meta data</legend>
									<label for="license"><span>Link to your license</span>
										<input type="text" name="license"
										placeholder="Link to your license" /> </label> <label for="keywords"><span>Comma
											separated keywords / tags</span> <input type="text" name="keywords"
										placeholder="Comma separated keywords / tags" /> </label>
								</fieldset>
							</div>
						</div>
						<button type="submit">Submit for moderation</button>
					</form>
				</div>
			</div>
		</div>
		<div id="footer">
			<p>
				Made with aid of <span class="randomName">marvelous bananas</span>
				at <a href="http://campudus.com">Campudus</a>
			</p>
		</div>
	</div>
</body>
</html>
